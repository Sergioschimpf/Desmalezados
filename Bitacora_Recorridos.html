<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bitácora de recorridos con rutas reales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #EDF1F2; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #1A73E8; }
    .field { margin-bottom: 10px; }
    .field label { display: block; font-weight: bold; margin-bottom: 4px; }
    .field input, .field textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    #map { height: 400px; margin: 10px 0; }
    #mapPreview img { max-width: 100%; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background: #1A73E8; color: #fff; }
    .no-print { display: inline-block; }
    @media print {
      button, .no-print { display: none !important; }
      #map { height: 400px !important; }
    }
  </style>
</head>
<body>
  <div id="bitacoraContent">
    <h1>Bitácora de recorridos</h1>
    <div class="field">
      <label for="fecha">Fecha</label>
      <input type="text" id="fecha" placeholder="YYYY-MM-DD">
    </div>
    <div class="field">
      <label for="empresa">Empresa Contratista</label>
      <input type="text" id="empresa">
    </div>
    <div class="field">
      <label for="tecnico">Técnico Interviniente</label>
      <input type="text" id="tecnico">
    </div>
    <div class="field">
      <label for="inicio">Coordenadas Inicio (Lat, Lon)</label>
      <input type="text" id="inicio" placeholder="-23.76166, -65.47649">
    </div>

    <h2>Intervenciones</h2>
    <div class="field">
      <label for="codigo">Código Sitio</label>
      <input type="text" id="codigo">
    </div>
    <div class="field">
      <label for="coord">Coordenadas Intervención (Lat, Lon)</label>
      <input type="text" id="coord">
    </div>
    <div class="field">
      <label for="tarea">Tarea</label>
      <textarea id="tarea"></textarea>
    </div>
    <div class="field">
      <label for="obs">Observación</label>
      <textarea id="obs"></textarea>
    </div>
    <button class="no-print" type="button" onclick="addIntervention()">Agregar Intervención</button>

    <div id="map"></div>

    <h2>Resumen de tramos</h2>
    <table>
      <thead>
        <tr><th>#</th><th>Código</th><th>Lat</th><th>Lon</th><th>Tarea</th><th>Obs</th><th>Dist (km)</th></tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr><td colspan="6">Total recorrido</td><td id="total">0.00</td></tr>
      </tfoot>
    </table>

    <div class="field no-print">
      <label for="mapFile">Adjuntar imagen del mapa</label>
      <input type="file" id="mapFile" accept="image/*">
      <div id="mapPreview"></div>
    </div>
  </div>

  <button class="no-print" type="button" onclick="generatePDF()">📄 Generar PDF</button>

  <script>
    flatpickr('#fecha', { dateFormat: 'Y-m-d' });

    const map = L.map('map').setView([-23.76166, -65.47649], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let interventions = [];
    const colors = ['#e74c3c', '#3498db', '#27ae60', '#f39c12', '#8e44ad'];
    const apiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjE5OTI4ZjNjZDRlNzQ2NjJiNDU0YzJiMmI5YTRkZGY5IiwiaCI6Im11cm11cjY0In0='; // <-- PON TU API KEY AQUÍ

    function addIntervention() {
      const code = document.getElementById('codigo').value.trim();
      const coordStr = document.getElementById('coord').value.trim();
      const task = document.getElementById('tarea').value.trim();
      const obs = document.getElementById('obs').value.trim();
      if (!code || !coordStr.includes(',')) return alert('Complete código y coordenadas correctamente');
      const [lat, lon] = coordStr.split(',').map(Number);
      if (isNaN(lat) || isNaN(lon)) return alert('Coordenadas inválidas');
      interventions.push({ code, lat, lon, task, obs });
      updateMap();
      ['codigo','coord','tarea','obs'].forEach(id => document.getElementById(id).value = '');
    }

    async function getRealRoute(prev, curr) {
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${prev[1]},${prev[0]}&end=${curr[1]},${curr[0]}`;
      const response = await fetch(url);
      const data = await response.json();
      const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      const distKm = data.features[0].properties.summary.distance / 1000;
      return { coords, distKm };
    }

    async function updateMap() {
      map.eachLayer(layer => {
        if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer);
      });
      const startStr = document.getElementById('inicio').value.trim();
      if (!startStr.includes(',')) return;
      let [lat0, lon0] = startStr.split(',').map(Number);
      const start = [lat0, lon0];

      L.marker(start, {icon: L.divIcon({html: '<div style="background:#333;color:#fff;border-radius:50%;width:24px;height:24px;line-height:24px;text-align:center;">0</div>'})}).addTo(map);
      let prev = start, total=0, html='';

      for (let i = 0; i < interventions.length; i++) {
        const int = interventions[i];
        const curr = [int.lat, int.lon];
        const col = colors[i%colors.length];
        const { coords, distKm } = await getRealRoute(prev, curr);
        L.polyline(coords, {color: col}).addTo(map);
        L.marker(curr, {icon: L.divIcon({html:`<div style="background:${col};color:#fff;border-radius:50%;width:24px;height:24px;line-height:24px;text-align:center;">${i+1}</div>`})}).addTo(map);
        html+=`<tr><td>${i+1}</td><td>${int.code}</td><td>${int.lat.toFixed(5)}</td><td>${int.lon.toFixed(5)}</td><td>${int.task}</td><td>${int.obs}</td><td>${distKm.toFixed(2)}</td></tr>`;
        total+=distKm; prev=curr;
      }

      document.getElementById('rows').innerHTML = html;
      document.getElementById('total').textContent = total.toFixed(2);
      const group = L.featureGroup();
      map.eachLayer(l => { if(l instanceof L.Marker || l instanceof L.Polyline) group.addLayer(l); });
      if (group.getLayers().length) map.fitBounds(group.getBounds(), {padding: [20, 20]});
    }

    document.getElementById('mapFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          const preview = document.getElementById('mapPreview');
          preview.innerHTML = '';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    function generatePDF() {
      html2pdf().set({ margin:0.5, filename:'bitacora.pdf' }).from(document.getElementById('bitacoraContent')).save();
    }
  </script>
</body>
</html>
